# Description: Feature centric ports for all Doom engine games
# URL:         http://www.zdoom.org/
# Depends on:  gtk3 libsdl2 libvpx libwebp openal zmusic libcppdap

name=gzdoom
version=4.14.2-092b9c0
release=1
source="https://github.com/ZDoom/$name/archive/${version#*-}/$name-$version.tar.gz
	fix-file-paths.patch
	gzdoom.desktop"

build() {
	patch -d $name-${version#*-}* -Np1 -i $SRC/fix-file-paths.patch

	CXXFLAGS="$CXXFLAGS -ffile-prefix-map=\"$PWD\"=."
	CXXFLAGS="$CXXFLAGS -DSHARE_DIR=\\\"/usr/share/gzdoom\\\""

	cmake -S $name-${version#*-}* -B build -G Ninja \
		-D CMAKE_BUILD_TYPE=Release \
		-D CMAKE_C_FLAGS_RELEASE="$CXXFLAGS" \
		-D CMAKE_CXX_FLAGS_RELEASE="$CXXFLAGS" \
		-D CMAKE_INSTALL_PREFIX=/usr \
		-D CMAKE_INSTALL_LIBDIR=lib \
		-D SYSTEMINSTALL=ON \
		-D INSTALL_PK3_PATH=share/gzdoom \
		-D INSTALL_SOUNDFONT_PATH=share/gzdoom \
		-D INSTALL_RPATH=/usr/lib \
		-D DYN_GTK=OFF \
		-D NO_GTK=OFF \
		-D DYN_OPENAL=OFF \
		-D FORCE_INTERNAL_BZIP2=OFF \
		-D FORCE_INTERNAL_CPPDAP=OFF \
		-D FORCE_INTERNAL_ZMUSIC=OFF \
		-D CMAKE_MODULE_PATH="/usr/lib/cmake/cppdap" \
		-D CPPDAP_SYSTEM_INSTALL=OFF \
		-D CPPDAP_INCLUDE_DIR=/usr/include/dap \

	ninja -C build -j ${JOBS:-1} -v
	DESTDIR=$PKG ninja -C build install

	# Remove bundled libcppdap (use the system one)
	cd $PKG/usr
	rm -r include/dap lib/cmake/cppdap lib/libcppdap.a
	rmdir include lib/cmake lib

	# Remove junk
	rm -r $PKG/usr/share/doc $PKG/usr/share/metainfo
}
